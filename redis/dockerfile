FROM node:18-alpine

WORKDIR /usr/src/app

COPY package.json ./
RUN npm install

COPY . .

# Create a startup script
RUN echo '#!/bin/sh' > start.sh && \
    echo 'until nc -z redis 6379; do' >> start.sh && \
    echo '  echo "Waiting for Redis...";' >> start.sh && \
    echo '  sleep 2;' >> start.sh && \
    echo 'done' >> start.sh && \
    echo 'echo "Redis is up - starting app"' >> start.sh && \
    echo 'node app.js' >> start.sh && \
    chmod +x start.sh

EXPOSE 3000

ENV REDIS_HOST=redis
ENV REDIS_PORT=6379

CMD ["./start.sh"]